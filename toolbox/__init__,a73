#
# RISC OS Toolbox
#

import swi
from swi import swi, block, integer

from .objects import *
from .gadgets import *

class IDBlock:
    def __init__(self):
        self.block = block(6)

    @property
    def ancestor_id(self):
        return self.block[0]
    @property
    def ancestor_component(self):
        return self.block[1]
    @property
    def parent_id(self):
        return self.block[2]
    @property
    def parent_component(self):
        return self.block[3]
    @property
    def self_id(self):
        return self.block[4]
    @property
    def self_component(self):
        return self.block[5]

def get_object(id):
    if id in _objects:
        return _objects[id]
    else:
        return None

def initialise(appdir):
    msgtrans_block = block(4)
    wimp_messages  = block(1)
    toolbox_events = block(1)
    wimp_messages [0] = 0
    toolbox_events[0] = 0

    swi('MessageTrans_OpenFile', 'bsi', msgtrans_block,
                                 appdir+'.Messages', 0)

    wimp_ver,task_handle,sprite_area = \
        swi('Toolbox_Initialise','iibbsbb;iii',
            0, 560, wimp_messages, toolbox_events,
            appdir, msgtrans_block, _id_block.block)

_quit = False
_objects = {}
_id_block = IDBlock()

def quit():
     global _quit
     _quit = True

def run():
    poll_block = block(64)

    while not _quit:
        reason,sender = swi('Wimp_Poll','ib;i.i', 0, poll_block)

        if reason == 512: # Toolbox Event
            size       = poll_block[0]
            reference  = poll_block[1]
            event_code = poll_block[2]
            flags      = poll_block[3]

            if event_code == 0x44ec1: # Object_AutoCreate
                name      = poll_block.nullstring(0x10,size)
                obj_class = swi('Toolbox_GetObjectClass', '0i;i',
                                _id_block.self_id)
                _objects[_id_block.self_id] = \
                     Object.create(obj_class, name, _id_block.self_id)

            object = get_object(_id_block.self_id)
            self_component = _id_block.self_component

            if object:
                if event_code == 0x828c3: # Menu_Selection
                    object.menu_selection(_id_block)

                if event_code == 0x82881: # ActionButton_Selected
                    object.actionbutton_selected(_id_block)

                if event_code == 0x82882: # OptionButton_StateChanged
                    object.optionbutton_state_changed(_id_block,
                        poll_block[4]) # new state

                if event_code == 0x82883: # RadioButton_StateChanged
                    object.radiobutton_state_changed(_id_block,
                        poll_block[4],poll_block[5]) # state, old_on_button)

                if event_code == 0x82885: # WritableField_ValueChanged
                    object.writablefield_changed(_id_block,
                        poll_block.nullstring(poll_bllock+16,size)) # string

                if event_code == 0x82886: # Slider_ValueChanged
                    object.slider_changed(_id_block,
                        poll_block[4]) # new value

                if event_code == 0x82887: # Draggable_DragStarted
                    object.drag_started(_id_block)

                if event_code == 0x82888: # Draggable_DragEnded
                    object.drag_ended(_id_block,
                        poll_block[4],poll_block[5],   # window, icon
                        (poll_block[6],poll_block[7])) # mouse pos (x,y)

                if event_code == 0x8288b: # Popup_AboutToBeShown
                    object.popup_about_to_be_shown(_id_block,
                        poll_block[4],poll_block[5],   # menu_id, show_type
                        (poll_block[6],poll_block[7])) # top left (x,y)

                if event_code == 0x8288c: # Adjuster_Clicked
                    object.adjuster_clicked(_id_block,
                        poll_block[4]) # direction

                if event_code == 0x8288d: # NumberRange_ValueChanged
                    object.numberrange_value_changed(_id_block,
                        poll_block[4]) # new value

                if event_code == 0x8288e: # StringSet_ValueChanged
                    object.stringset_value_changed(_id_block,
                        poll_block.nullstring(16, size)) # string

                if event_code == 0x8288f: # StringSet_AboutToBeShown
                    object.stringset_about_to_be_shown(_id_block)

                if event_code == 0x140181: # ScrollList_Selection
                    object.scrolllist_selection(_id_block,
                        poll_block[4],poll_block[5]) # flags, item

        if reason == 17: # Wimp Message
            if poll_block[4] == 0:
                quit()
